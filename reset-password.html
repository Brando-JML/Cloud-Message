<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restablecer Contrase√±a</title>
    <link rel="stylesheet" href="reset-password.css">
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="wrapper">
        <form id="resetForm" action="#">
            <h1>Restablecer Contrase√±a</h1>
            
            <!-- PASO 1: Verificar identidad con tel√©fono -->
            <div class="step active" id="step1">
                <div class="step-indicator">Paso 1 de 2: Verificar identidad</div>
                
                <div class="info-box">
                    Ingresa tu n√∫mero de tel√©fono registrado para verificar tu identidad.
                </div>
                
                <div class="input-box">
                    <input type="tel" id="phoneNumber" placeholder="N√∫mero de tel√©fono" required>
                    <i class='bx bx-phone'></i>
                </div>
                
                <p id="error-message-step1" class="error-message"></p>
                
                <button type="button" class="btn" id="verifyPhoneBtn">Verificar tel√©fono</button>
            </div>
            
            <!-- PASO 2: Enviar enlace de recuperaci√≥n -->
            <div class="step" id="step2">
                <div class="step-indicator">Paso 2 de 2: Recuperaci√≥n</div>
                
                <div class="info-box success">
                    <strong>‚úì Usuario encontrado</strong><br>
                    <span id="userInfo"></span>
                </div>
                
                <p style="text-align: center; margin-bottom: 20px; font-size: 14px;">
                    Se enviar√° un enlace a tu correo electr√≥nico registrado para restablecer la contrase√±a.
                </p>
                
                <button type="button" class="btn" id="sendEmailBtn">
                    <i class='bx bx-envelope'></i> Enviar enlace por email
                </button>

                <p id="error-message-step2" class="error-message"></p>
            </div>

            <div class="register-link">
                <p>¬øRecordaste tu contrase√±a? <a href="login.html">Iniciar sesi√≥n</a></p>
            </div>
        </form>
    </div>

    <!-- Configuraci√≥n de Firebase -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBVEltBir1JP3-Fkp28VchL8-r0VMi-LYo",
            authDomain: "cloudmessage-73de0.firebaseapp.com",
            projectId: "cloudmessage-73de0",
            storageBucket: "cloudmessage-73de0.firebasestorage.app",
            messagingSenderId: "40058388963",
            appId: "1:40058388963:web:821cda7114279a336e20d6",
            measurementId: "G-W0BMTSZWXC"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        console.log('üî• Firebase inicializado');
    </script>

    <script>
        const verifyPhoneBtn = document.getElementById('verifyPhoneBtn');
        const sendEmailBtn = document.getElementById('sendEmailBtn');
        const phoneNumber = document.getElementById('phoneNumber');
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        let foundUser = null;

        /* ==========================================
           PASO 1: VERIFICAR TEL√âFONO
        ========================================== */
        verifyPhoneBtn.addEventListener('click', async () => {
            const phone = phoneNumber.value.trim();
            const errorMsg = document.getElementById('error-message-step1');
            
            if (phone.length < 10) {
                showError(errorMsg, '‚ö†Ô∏è Ingresa un n√∫mero de tel√©fono v√°lido');
                return;
            }
            
            verifyPhoneBtn.classList.add('loading');
            verifyPhoneBtn.textContent = 'Buscando...';
            errorMsg.textContent = '';
            
            try {
                const usersRef = db.collection('users');
                const snapshot = await usersRef.where('telefono', '==', phone).get();
                
                if (snapshot.empty) {
                    showError(errorMsg, '‚ö†Ô∏è No se encontr√≥ ning√∫n usuario con este tel√©fono');
                    return;
                }
                
                const userDoc = snapshot.docs[0];
                foundUser = {
                    uid: userDoc.id,
                    ...userDoc.data()
                };
                
                console.log('‚úÖ Usuario encontrado:', foundUser);
                
                document.getElementById('userInfo').innerHTML = `
                    Email: ${foundUser.email}<br>
                    Nombre: ${foundUser.nombre} ${foundUser.apellidos}
                `;
                
                goToStep(2);
                
            } catch (error) {
                console.error('‚ùå Error:', error);
                showError(errorMsg, '‚ùå Error al buscar usuario. Intenta de nuevo.');
            } finally {
                verifyPhoneBtn.classList.remove('loading');
                verifyPhoneBtn.textContent = 'Verificar tel√©fono';
            }
        });

        /* ==========================================
           PASO 2: ENVIAR EMAIL DE RECUPERACI√ìN
        ========================================== */
        sendEmailBtn.addEventListener('click', async () => {
            const errorMsg = document.getElementById('error-message-step2');
            
            if (!foundUser) {
                showError(errorMsg, '‚ö†Ô∏è Error: Usuario no encontrado');
                return;
            }
            
            sendEmailBtn.classList.add('loading');
            sendEmailBtn.innerHTML = '<i class="bx bx-loader-alt bx-spin"></i> Enviando...';
            errorMsg.textContent = '';
            
            try {
                await auth.sendPasswordResetEmail(foundUser.email);
                showSuccess(errorMsg, `‚úÖ Email enviado a ${foundUser.email}. Revisa tu bandeja de entrada.`);
                
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 3000);
                
            } catch (error) {
                console.error('‚ùå Error:', error);
                let errorMessage = '‚ùå Error al enviar email. Intenta de nuevo.';
                if (error.code === 'auth/user-not-found') {
                    errorMessage = '‚ö†Ô∏è Usuario no encontrado en Authentication.';
                }
                showError(errorMsg, errorMessage);
            } finally {
                sendEmailBtn.classList.remove('loading');
                sendEmailBtn.innerHTML = '<i class="bx bx-envelope"></i> Enviar enlace por email';
            }
        });

        /* ==========================================
           FUNCIONES AUXILIARES
        ========================================== */
        function goToStep(stepNumber) {
            step1.classList.remove('active');
            step2.classList.remove('active');
            if (stepNumber === 1) step1.classList.add('active');
            else step2.classList.add('active');
        }

        function showError(element, message) {
            element.textContent = message;
            element.style.color = '#ff6b6b';
            element.animate([
                { transform: 'translateX(0)' },
                { transform: 'translateX(-6px)' },
                { transform: 'translateX(6px)' },
                { transform: 'translateX(0)' }
            ], { duration: 150 });
        }

        function showSuccess(element, message) {
            element.textContent = message;
            element.style.color = '#8ef58e';
        }
    </script>
</body>
</html>
